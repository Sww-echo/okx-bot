# OKX 交易机器人核心策略白皮书

> [!NOTE]
> 本文档旨在为量化交易者和开发者提供该项目的**深度技术细节**。内容涵盖数学模型、状态机逻辑、参数配置及异常处理机制。

---

## 1. 系统架构与数据流

本系统基于 **Python 异步编程 (asyncio)** 构建，采用事件驱动与轮询结合的架构。核心数据流如下：

```mermaid
graph TD
    Market[OKX 行情流] -->|Tick (5s)| Trader[GridTrader]
    Trader -->|价格/资产| Risk[RiskManager]
    Trader -->|最新价| Strategy[GridStrategy]
    
    subgraph 决策层
        Risk -->|Pass/Fail| Trader
        Strategy -->|Signal (Buy/Sell)| Trader
        S1[S1Strategy] -->|Position Rebalance| Trader
    end
    
    subgraph 执行层
        Trader -->|Order| Exchange[ExchangeClient]
        Exchange -->|Fill/Partial| Balance[BalanceService]
        Balance -->|Update| Risk
    end
    
    subgraph 数据层
        Trader -->|Save State| Persistence[JSON Storage]
        Exchange -->|Trade Log| OrderManager
    end
```

---

## 2. 策略引擎详解

### 2.1 动态网格策略 (Core Strategy)

核心思想：基于**对数收益率**捕捉短期波动，通过高频买卖实现均值回归套利。

#### **数学模型**
定义 $P_t$ 为 $t$ 时刻价格，$P_{base}$ 为基准价格，$G$ 为网格大小（百分比）。
价差比例 $\Delta P$ 计算如下：

$$
\Delta P = \frac{P_t - P_{base}}{P_{base}}
$$

#### **信号触发条件**
- **卖出信号 (Short)**:
  $$ \Delta P \ge G $$
  - 动作：卖出 `Amount`
  - 更新基准价：$P_{base} \leftarrow P_t$
  
- **买入信号 (Long)**:
  $$ \Delta P \le -G $$
  - 动作：买入 `Amount`
  - 更新基准价：$P_{base} \leftarrow P_t$

#### **网格大小动态调节 (Adaptive Grid)**
网格大小 $G$ 不是固定的，而是基于市场波动率 $\sigma$ 动态调整：
$$ G_t = f(\sigma_{24h}) $$

其中 $\sigma_{24h}$ 是过去 24 小时对数收益率的年化标准差：
$$ \sigma = \text{std}(\ln(P_t/P_{t-1})) \times \sqrt{24 \times 365} $$

**映射规则**:
| 波动率 $\sigma$ | 网格大小 $G$ | 策略意图 |
| :--- | :--- | :--- |
| $\sigma < 0.2$ | **1.0%** | 低波动，频繁套利 |
| $0.2 \le \sigma < 0.4$ | **1.5%** | 正常波动 |
| $0.4 \le \sigma < 0.6$ | **2.0%** | 加大网格，防止过多磨损 |
| $\sigma \ge 1.2$ | **4.0%** | 极端行情，大幅放宽网格 |

> **详细代码**: `src.strategies.grid.GridStrategy.update_grid_size`

---

### 2.2 S1 仓位辅助策略 (Trend Assistant)

S1 策略用于在长期趋势中辅助调整底仓，基于 Donchian Channel (唐奇安通道) 思想。

#### **参数定义**
- **周期 ($T$)**: 52 天 (约 2 个月)
- **高位阈值 ($R_{high}$)**: 50%
- **低位阈值 ($R_{low}$)**: 70%

#### **计算逻辑**
1. **每日更新**: 每 24 小时获取一次最近 $T$ 日的日线数据。
2. **极值计算**:
   $$ H_{52} = \max(High_{t-1}, ..., High_{t-52}) $$
   $$ L_{52} = \min(Low_{t-1}, ..., Low_{t-52}) $$
   
3. **执行逻辑**:
   - **减仓 (Take Profit)**:
     - 条件: $P_t > H_{52}$ **且** 当前仓位 $> R_{high}$
     - 目标: 卖出至仓位 $= R_{high}$ (保留 50% 底仓)
     
   - **加仓 (Buy Dip)**:
     - 条件: $P_t < L_{52}$ **且** 当前仓位 $< R_{low}$
     - 目标: 买入至仓位 $= R_{low}$ (增加至 70% 仓位)

> **详细代码**: `src.strategies.position.S1Strategy.check_and_execute`

---

## 3. 风险管理体系 (Risk Management)

本系统采用三层风控机制 (`RiskManager`)，具有最高优先级的**否决权**。

### 3.1 资产保护 (Cut-off)

#### **总资产回撤止损 (Drawdown Stop)**
监控账户净值回撤幅度，防止本金遭受毁灭性打击。
$$ D = \frac{A_{peak} - A_{current}}{A_{peak}} $$

- **阈值**: 15% (`MAX_DRAWDOWN`)
- **触发动作**:
  1. 暂停所有**买入**交易。
  2. 发送 **CRITICAL** 级别告警 (钉钉/企业微信)。
  3. 系统进入 `Risk Lock` 状态。

#### **每日亏损熔断 (Daily Limit)**
防止单日大幅亏损，强制冷静期。
- **重置时间**: UTC 00:00
- **阈值**: 初始本金的 5% (`DAILY_LOSS_LIMIT`)
- **触发动作**: 暂停当日所有新开仓位，直至次日 0 点。

### 3.2 连续亏损保护 (Consecutive Loss Circuit Breaker)
防止在单边不利行情中频繁试错。

- **计数器**: $N_{loss}$ (连续亏损交易笔数)
- **触发条件**: $N_{loss} \ge 5$ (`MAX_CONSECUTIVE_LOSSES`)
- **冷却机制**:
  - 触发后，系统进入 `COOLDOWN` 状态。
  - 暂停交易 **300 秒** (`LOSS_COOLDOWN`)。
  - 冷却结束后，$N_{loss}$ 重置为 0。
- **重置条件**: 只要有一笔盈利交易，$N_{loss}$ 立即重置为 0。

### 3.3 仓位硬约束 (Position Limits)
- **最大仓位**: 90% (预留 10% 保证金缓冲)
- **最小底仓**: 10% (防止踏空)
- **自动补仓**: 当仓位 $< 10\%$ 时，系统通过 `Market Order` 自动补足至 10%。

> **详细代码**: `src.risk.manager.RiskManager`

---

## 4. 资金管理与执行 (Execution)

### 4.1 交易量计算 (Position Sizing)
单笔交易量 $V_{trade}$ 基于总资产动态计算：

$$ V_{trade} = \max(20\text{ USDT}, A_{total} \times 0.05) $$

- **下限**: 20 USDT (满足交易所最小下单金额)
- **比例**: 每次投入总资金的 5%，这种小步快跑策略有助于摊薄成本。

### 4.2 永续合约适配 (Perpetual Swap)
系统针对 OKX 永续合约进行了专门适配：
- **交易对**: `ETH-USDT-SWAP`
- **杠杆**: **20x**
- **模式**: **全仓 (Cross Margin)**
- **单位换算**: 下单时自动将 USDT 金额转换为合约张数 (Contracts)。

---

## 5. 异常处理与系统鲁棒性

### 5.1 网络异常处理
- **HTTP 错误**: 捕获 `httpx.ConnectError`, `ReadTimeout` 等异常。
- **指数退避 (Exponential Backoff)**:
  - 失败第 1 次: 等待 1 秒
  - 失败第 2 次: 等待 2 秒
  - ...
  - 失败第 5 次: 等待 16 秒

### 5.2 优雅退出 (Graceful Shutdown)
当接收到 `SIGINT` (Ctrl+C) 或 `SIGTERM` 信号时，系统执行以下原子操作：
1. **设置标志位**: `_running = False`，停止主循环。
2. **持久化状态**:
   - `base_price` (基准价)
   - `grid_size` (当前网格)
   - `trade_history` (交易流水)
   - 保存至 `data/*.json` 文件。
3. **关闭连接**: 等待正在进行的 API 请求完成，然后关闭 HTTP 会话。
4. **发送报告**: 推送最终状态报告给用户。

> **详细代码**: `src.core.trade.GridTrader.shutdown`

---

## 6. 环境配置参考

环境变量 (`.env`) 与核心参数映射：

| 环境变量 | 参数名 | 默认值 | 作用 |
|:--- |:--- |:--- |:--- |
| `TRADE_MODE` | 交易模式 | `swap` | `spot`=现货, `swap`=合约 |
| `LEVERAGE` | 杠杆倍数 | `20` | 仅合约模式生效 |
| `INITIAL_BASE_PRICE` | 初始基准价 | `0` | `0`=使用启动时市价 |
| `INITIAL_PRINCIPAL` | 初始本金 | `1000` | 用于盈亏计算 |
| `DINGTALK_WEBHOOK` | 钉钉通知 | - | 必需，用于告警 |

---
*Generated by Antigravity Agent, 2026-02-10*
